export default class Table extends HTMLElement {
	static observedAttributes = ['columns', 'filters', 'page', 'page-size', 'rows'];

	#allowSelection = false;
	#anchor = null;
	#initialized = false;
	#multiFilterOperator = 'AND'; 
	#rowsUnfiltered = null;

	constructor() {
		super();
		this.attachShadow({ mode: 'open' });
		this.shadowRoot.innerHTML = `
			<style>
				* {
					box-sizing: border-box;
				}
				:host {
					display: block;
					width: 100%;
				}
				:host([allow-selection='true']) .row:not(#row-header):not(#row-footer), input {
					cursor: pointer;
				}
				.body {
					display: flex;
					flex-direction: column;
				}
				.cell {
					display: flex;
					flex: 1;
					padding: 5px;
				}
				.cell:not(:first-child) {
					border-left: 1px solid black;
				}
				.filter {
					display: flex;
				}
				.filter[data-type="string"] .number {
					display: none;
				}
				.filter[data-type="number"] .string {
					display: none;
				}
				#filter-popup .filter:first-child .filter-and-or {
					visibility: hidden;
				}
				.footer:not(:empty) {
					border-top: 1px solid black;
				}
				.footer-inner {
					display: flex;
					flex: 1;
					gap: 5px;
					justify-content: flex-end;
					user-select: none;
				}
				.footer-inner:first-child {
					flex: 3;
					justify-content: flex-start;
				}
				.header {
					font-weight: bold;
				}
				.header:not(:empty) {
					border-bottom: 1px solid black;
				}
				.header .cell {
					position: relative;
				}
				.header .cell > span {
					position: relative;
				}
				.header .cell.has-filter > span:before {
					background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAQAAABKfvVzAAAAbUlEQVQ4y2NgGE5gK8N/PHATpoZDeDUcwNSgwPAWp/I3DHLYHOXJ8Ber8r8Mbrj8UY9VQy1ujzMxbMNQvoWBEV9YCTHcQ1F+j0GQUPAaMXyHK/8O5BEBkuEakoiNRJgGhlENeMARsPIjDMMUAABg/nwFPtIxLAAAAABJRU5ErkJggg==');
					background-size: cover;
					content: '';
					height: 15px;
					left: calc(100% + 10px);
					position: absolute;
					top: 50%;
					transform: translateY(-50%);
					width: 15px;
				}
				.header .cell[class*="sort"] {
					justify-content: space-between;
				}
				.header .cell.sort-none:after {
					content: '';
				}
				.header .cell.sort-ascending > span:after {
					content: '\\2191';
				}
				.header .cell.sort-descending > span:after {
					content: '\\2193';
				}
				.header .cell:hover > button {
					opacity: 1;
				}
				.header .cell > button {
					opacity: 0;
					position: absolute;
					right: 0;
					top: 50%;
					transform: translateY(-50%);
					transition: opacity .2s ease;
				}
				.pages {
					display: flex;
				}
				.popup {
					background-color: white;
					display: none;
					flex-direction: column;
					left: 0;
					position: absolute;
					top: 32px;
					transform: translateX(-100%);
					white-space: nowrap;
				}
				.popup.visible {
					display: flex;
				}
				.row {
					display: flex;
					user-select: none;
				}
				.row[aria-selected='true'] {
					background: #D7DFF3;
				}
				.row + .row {
					border-top: 1px solid black;
				}
				#row-footer {
					justify-content: space-between;
					padding: 5px;
					place-items: center;
				}
				#row-footer button {
					background: none;
					border: none;
					cursor: pointer;
					display: flex;
					place-self: center;
				}
				#row-footer button:disabled {
					cursor: default;
					pointer-events: none;
				}
				.table {
					border: 1px solid black;
					position: relative;
				}
			</style>
			<div class='table'>
				<div class='header'></div>
				<div class='body'></div>
				<div class='footer'>
					<div class='row' id='row-footer'>
						<div class='footer-inner'>
							<span id='selected-number' hidden='true'></span>
							<span id='selected-single' hidden='true'>row selected</span>
							<span id='selected-multi' hidden='true'>rows selected</span>
						</div>
						<div class='footer-inner'>
							<span style='font-size: 11px; place-self: center;'>Rows per page:</span>
							<select id='page-size'>
								<option value='10'>10</option>
								<option value='25'>25</option>
								<option value='50'>50</option>
								<option value='100'>100</option>
							</select>
						</div>
						<div class='footer-inner'>
							<div id='current-page'>0</div>
							of
							<div id='total-pages'>0</div>
							<button id='prev-page' style='border: none; padding: 0;'>
								<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24">
									<path d="M561-240 320-481l241-241 43 43-198 198 198 198-43 43Z"/>
								</svg>
							</button>
							<button id='next-page' style='border: none; padding: 0;'>
								<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24">
									<path d="m375-240-43-43 198-198-198-198 43-43 241 241-241 241Z"/>
								</svg>
							</button>
						</div>
					</div>
				</div>
				<div id='popup' class='popup'>
					<button id='sort-asc-btn'>Sort ASC</button>
					<button id='sort-desc-btn'>Sort DESC</button>
					<button id='filter-btn'>Filter</button>
					<button id='manage-columns-btn'>Manage Columns</button>
				</div>
				<div id='visibility-popup' class='popup'></div>
				<div id='filter-popup' class='popup'></div>
			</div>
			<template id='filter-template'>
				<div class='filter'>
					<button class='filter-remove-btn'>X</button>
					<select class='filter-and-or'>
						<option value='AND'>AND</option>
						<option value='OR'>OR</option>
					</select>
					<select class='filter-column'></select>
					<select class='filter-operator number'>
						<option value='='>=</option>
						<option value='!='>!=</option>
						<option value='>'>&gt;</option>
						<option value='>='>&gt;=</option>
						<option value='<'>&lt;</option>
						<option value='<='>&lt;=</option>
						<option value='empty'>is empty</option>
						<option value='not_empty'>is not empty</option>
					</select>
					<select class='filter-operator string'>
						<option value='contains'>contains</option>
						<option value='equals'>equals</option>
						<option value='starts_with'>starts with</option>
						<option value='ends_with'>ends with</option>
						<option value='empty'>is empty</option>
						<option value='not_empty'>is not empty</option>
					</select>
					<input class='filter-input number' type='number'></input>
					<input class='filter-input string' type='text'></input>
				</filter>
			</template>
		`;
		this.ASC = 'ascending';
		this.DES = 'descending';
		this.NONE = 'none';
		this._columns = null;
		this._page = 0;
		this._pageSize = 10;
		this._rows = null;
		this._filters = null;
	}

	get page() { return this._page; }
	set page(newVal) {
		if (newVal != this._page) {
			this._page = newVal;
			this.#footerCurrentPage.innerText = newVal + 1;
			this.forceRender();
		}
	}

	get pageSize() { return this._pageSize; }
	set pageSize(newVal) {
		if (newVal === this._pageSize) return;
		this._pageSize = newVal;
		const el = this.shadowRoot.querySelector('select');
		[...el?.options || []].forEach((a) => {
			if (parseInt(a.innerHTML) === this._pageSize) {
				el.setAttribute('selected', a.id);
			}
		});

		const topEl = [...this.#body.childNodes][0] || {};
		const topIndex = parseInt(topEl?.id?.match(/\d+/));
		if (!topEl || isNaN(topIndex)) return;
		const range = this.getCurrentRange();

		if (topIndex < range.min || topIndex > range.max) {
			const findPage = (page) => {
				const border = topIndex < range.min ? page * newVal : (page + 1) * newVal;
				return topIndex < border ? findPage(topIndex < range.min ? page - 1 : page + 1) : page;
			}
			this.page = findPage(this.page);
		}
		this.forceRender();
	}

	get rows() { return this._rows; }
	set rows(newVal) {
		this.#rowsUnfiltered = newVal;
		this._rows = this.rowsFilter(this.rowsSort(newVal));
		this.forceRender();
	}

	get columns() { return this._columns; }
	set columns(newVal) {
		this._columns = newVal;
		this.forceRender();
	}

	get filters() { return this._filters || []; }
	set filters(newVal) {
		this._filters = newVal;
		if (this.#rowsUnfiltered) {
			this.rows = this.#rowsUnfiltered;
		}
	}

	get #body() { return this.shadowRoot.querySelector('.body'); }
	get #popup() { return this.shadowRoot.querySelector('#popup'); }
	get #visibilityPopup() { return this.shadowRoot.querySelector('#visibility-popup'); }
	get #filterPopup() { return this.shadowRoot.querySelector('#filter-popup'); }
	get #footerCurrentPage() { return this.shadowRoot.querySelector('#current-page'); }
	get #footerPageSize() { return this.shadowRoot.querySelector('#page-size'); }
	get #footerPrevBtn() { return this.shadowRoot.querySelector('#prev-page'); }
	get #footerNextBtn() { return this.shadowRoot.querySelector('#next-page'); }
	get #footerSelectedMulti() { return this.shadowRoot.querySelector('#selected-multi'); }
	get #footerSelectedNumber() { return this.shadowRoot.querySelector('#selected-number'); }
	get #footerSelectedSingle() { return this.shadowRoot.querySelector('#selected-single'); }
	get #footerTotalPages() { return this.shadowRoot.querySelector('#total-pages'); }
	get #header() { return this.shadowRoot.querySelector('.header'); }
	get selected() { return this._rows?.filter(a => a._selected ) || []; }

	attributeChangedCallback(attr, oldVal, newVal) {
		if (!this.#initialized) return;

		switch(attr) {
			case 'columns':
				this.columns = JSON.parse(newVal);
				break;
			case 'filters':
				this.filters = JSON.parse(newVal);
				break;
			case 'page':
				this.page = newVal;
				break;
			case 'page-size':
				this.pageSize = newVal;
				break;
			case 'rows':
				this.rows = JSON.parse(newVal);
				break;
		}
	}

	connectedCallback() {
		const columns = this.getAttribute('columns');
		this.columns = columns ? JSON.parse(columns) : null;
		const filters = this.getAttribute('filters');
		this.filters = filters ? JSON.parse(filters) : null;
		const page = this.getAttribute('page');
		if (page != null && !isNaN(page)) {
			this.page = parseInt(page);
		}
		const pageSize = parseInt(this.getAttribute('page-size'));
		if (pageSize != null && !isNaN(pageSize)) {
			this.pageSize = pageSize;
		}
		this.#allowSelection = this.getAttribute('allow-selection') === 'true';
		this.#multiFilterOperator = this.getAttribute('multi-filter-operator')?.toUpperCase() === 'AND' ? 'AND' : 'OR';
		
		this.#footerNextBtn.addEventListener('click', this.setNextPage);
		this.#footerPrevBtn.addEventListener('click', this.setPrevPage);
		this.#footerPageSize.addEventListener('change', this.setPageSize);
		this.#popup.addEventListener('click', (e) => e.stopPropagation());
		this.#visibilityPopup.addEventListener('click', (e) => e.stopPropagation());
		this.#filterPopup.addEventListener('click', (e) => e.stopPropagation());
		this.shadowRoot.querySelector('#manage-columns-btn').addEventListener('click', this.onManageColumnsClick);
		this.shadowRoot.querySelector('#sort-asc-btn').addEventListener('click', () => this.sortColumn(this.ASC));
		this.shadowRoot.querySelector('#sort-desc-btn').addEventListener('click', () => this.sortColumn(this.DES));
		this.shadowRoot.querySelector('#filter-btn').addEventListener('click', this.onFilterClick);
		document.addEventListener('click', this.onClickOutside);
		this.#initialized = true;
		this.forceRender();
	}

	disconnectedCallback() {
		document.removeEventListener('click', this.onClickOutside);
	}

	buildCell = (data, cellIndex, rowIndex, column) => {
		if (column.hidden) return null;

		const element = document.createElement('div');
		element.classList.add('cell');
		element.classList.add(column.type);
		element.style.flex = column.flex || '1 1 100%';

		element.setAttribute('id', `cell-${cellIndex}`);
		const render = column.render;
		element.innerHTML = render ? `<slot name="${rowIndex}-${cellIndex}"></slot>` : data;

		if (render) {
			const el = document.createElement('span');
			el.innerHTML = render(data);
			el.firstElementChild.slot = `${rowIndex}-${cellIndex}`;
			this.shadowRoot.host.appendChild(el.firstElementChild);
		}

		return element;
	}

	buildCellHeader = ({ name, flex, sort, type }, index, column) => {
		if (column.hidden) return null;

		const hasFilter = this.filters && this.filters.find(a => a.column === column.property);
		const element = document.createElement('div');
		const content = document.createElement('span');
		content.textContent = name;
		element.className = `cell ${hasFilter ? 'has-filter' : ''} sort-${sort}`;
		element.setAttribute('data-property', column.property);
		element.style.flex = flex;
		element.setAttribute('id', `cell-${index}`);
		element.appendChild(content);
		element.addEventListener('click', () => this.toggleSort(column));
		const menuBtn = document.createElement('button');
		menuBtn.textContent = '\u1392';
		menuBtn.addEventListener('click', (e) => this.onSelectHeaderButton(e, column));
		element.appendChild(menuBtn);
		return element;
	}
	
	buildRow = (row, index, isHeader) => {
		const element = document.createElement('div');
		element.classList.add('row');
		element.id = isHeader ? 'row-header' : `row-${index}`;

		if (this.#allowSelection) {
			const selector = document.createElement('span');
			selector.className = 'cell selectable';
			selector.style.flex = '0 0 20px';

			const inner = document.createElement('input');
			inner.type = 'checkbox';
			inner.checked = row._selected;
			element.ariaSelected = row._selected;

			selector.append(inner);
			element.append(selector);

			if (!isHeader) {
				element.addEventListener('click', (e) => this.onSelectRow(e, index));
			} else {
				inner.addEventListener('click', this.onSelectAllRows);
			}
		}
		
		const rowData = isHeader ? Object.values(row) : this.columns.map((a) => row[a?.property] ?? null);
		const rowElements = rowData.map((data, i) => isHeader ? this.buildCellHeader(data, i, this.columns[i]) : this.buildCell(data, i, index, this.columns[i]));
		rowElements.filter(Boolean).forEach(el => element.append(el));

		return element;
	}

	fireChangeEvent = () => this.dispatchEvent(new Event('change', { 'bubbles': false, 'cancelable': true, 'composed': true }));

	forceRender = () => {
		if (!this.#initialized || !this._rows || !this._columns) return;

		this.updateTotalPages();
		this.updateHeader();
		this.updateFooter();
		this.updateVisibilityPopup();
		this.updateFilterPopup();
		this.shadowRoot.host.innerHTML = '';
		this.#body.innerHTML = '';
		const isAllSelected = this._rows.every(a => a._selected);
		const range = this.getCurrentRange();
		if (this.#allowSelection) {
			this.#header.querySelector('input').checked = isAllSelected;
		}
		this._rows.forEach((row, index) => {
			this.shadowRoot.getElementById(`row-${index}`)?.remove();
			if (index >= range.min && index < range.max) {
				const el = this.buildRow(row, index, false);
				this.#body.appendChild(el);
			}
		});
	}

	getElementPositionRelativeToOtherElement = (element, otherElement) => {
		const elementRect = element.getBoundingClientRect();
		const otherElementRect = otherElement.getBoundingClientRect();
		const positionTop = elementRect.top - otherElementRect.top;
		const positionLeft = elementRect.left - otherElementRect.left;
		return { top: positionTop, left: positionLeft };
	}

	getCurrentRange = () => {
		const offset = this.pageSize;
		const min = this.page * offset;
		const max = (this.page + 1) * offset;
		return { min, max };
	}

	getTotalPages = () => {
		if (this.rows?.length) {
			return Math.ceil(this.rows.length / this.pageSize);
		}
		return 0;
	}

	hidePopups = () =>	this.shadowRoot.querySelectorAll('.popup.visible').forEach(el => el.classList.remove('visible'));

	onClickOutside = (e) => {
		const checkClick = (el) => {
			const isPopupVisible = el.classList.contains('visible');
			const isClickedOutside = !el.contains(e.target);
			if (isPopupVisible && isClickedOutside) {
				el.classList.remove('visible');
			}
		};
		checkClick(this.#popup);
		checkClick(this.#visibilityPopup);
		checkClick(this.#filterPopup);
	}

	onFilterClick = () => {
		this.#popup.classList.remove('visible');
		this.updateFilterPopup();
		this.#filterPopup.classList.add('visible');
	}

	onManageColumnsClick = (e) => {
		this.#popup.classList.remove('visible');
		this.#visibilityPopup.classList.add('visible');
	}

	onSelectHeaderButton = (e, col) => {
		e.stopPropagation();
		this.currentColumn = col;
		this.hidePopups();
		const { width, height } = e.target.getBoundingClientRect();
		const { left, top } = this.getElementPositionRelativeToOtherElement(e.target, this.shadowRoot.querySelector('.table'));
		this.#popup.style.left = `${left + width}px`;
		this.#popup.style.top = `${top + height}px`;
		this.#visibilityPopup.style.left = `${left + width}px`;
		this.#visibilityPopup.style.top = `${top + height}px`;
		this.#filterPopup.style.left = `${left + width}px`;
		this.#filterPopup.style.top = `${top + height}px`;
		this.#popup.classList.add('visible');
	}
	
	onSelectAllRows = () => {
		const isAllSelected = this._rows.every(a => a._selected);
		this._rows.forEach(a => a._selected = !isAllSelected);
		this.forceRender();
		this.fireChangeEvent();
	}
	
	onSelectRow = (e, index) => {
		if (e.shiftKey) {
			const createRange = (start, end) => Array.from({length: end - start + 1}, (v, k) => k + start);
			const selections = createRange(this.#anchor > index ? index : this.#anchor, this.#anchor > index ? this.#anchor : index);
			selections.forEach(i => this._rows[i]._selected = true);
		} else {
			const row = this._rows[index];
			this.#anchor = index;
			row._selected = !row._selected;
		}
		this.forceRender();
		this.fireChangeEvent();
	}
	
	rowsSort = (r) => {
		const rows = [...r];
		this.columns.map((col) => col.sort).forEach((sort, i) => {
			if (sort == this.NONE) return;

			const { type, property } = this.columns[i];
			rows.sort((a, b) => {
				const aa = a[property]; 
				const bb = b[property];
				if (aa == null && bb == null) return 0;
				if (aa == null || bb == null) return aa == null ? -1 : 1;

				let result = 0;
				if (type === 'number') {
					result = aa < bb ? -1 : 1;
				} else if (type === 'string') {
					result = aa.toLowerCase().localeCompare(bb.toLowerCase());
				}
				return sort == this.DES ? result : -result;
			});
		});
		return rows;
	}

	rowsFilter = (rows) => {
		const operators = {
			'=': (a, b) => Number(a) === Number(b),
			'!=': (a, b) => Number(a) !== Number(b),
			'>': (a, b) => Number(a) > Number(b),
			'>=': (a, b) => Number(a) >= Number(b),
			'<': (a, b) => Number(a) < Number(b),
			'<=': (a, b) => Number(a) <= Number(b),
			'empty': (a) => `${a}`.length === 0,
			'not_empty': (a) => `${a}`.length > 0,
			'contains': (a, b) => a.toLowerCase().indexOf(b.toLowerCase()) >= 0,
			'equals': (a, b) => a.toLowerCase() === b.toLowerCase(),
			'starts_with': (a, b) => a.toLowerCase().startsWith(b.toLowerCase()),
			'ends_with': (a, b) => a.toLowerCase().endsWith(b.toLowerCase()),
			'AND': (arr) => arr.every(a => a),
			'OR': (arr) => arr.some(a => a)
		};
		
		const fitleredRows = rows.filter(row => {
			const results = this.filters.map(({ column, operator, value }) => {
				const result = operators[operator](row[column], value);
				return result;
			});	
			return results.length > 0 ? operators[this.#multiFilterOperator](results) : row;
		});
		return fitleredRows;
	}

	setNextPage = () => {
		if (this.page + 1 < this.getTotalPages()) {
			this.page = this.page + 1;
		}
	}

	setPrevPage = () => {
		if (this.page - 1 >= 0) {
			this.page = this.page - 1;
		}
	}

	setPageSize = (e) => this.pageSize = parseInt(e.target.value);
	
	sortColumn = (dir) => {
		if (this.currentColumn) {
			const headerCell = this.#header.querySelector(`.row > .cell[data-property="${this.currentColumn.property}"]`);
			const cells = this.#header.querySelectorAll('.row > .cell:not(.selectable)');
			
			this.#anchor = null;
			cells.forEach(a => a.className = `cell`);
			this.columns.forEach(a => a.sort = this.NONE);
			this.currentColumn.sort = dir;
			headerCell.classList.add(`sort-${dir}`);
			this.rows = [...this._rows];
			this.fireChangeEvent();
			this.hidePopups();
		}
	}

	toggleSort = (column) => {
		this.currentColumn = column;
		const sortCycle = { [this.NONE]: this.DES, [this.DES]: this.ASC, [this.ASC]: this.NONE };
		const newSort = sortCycle[column.sort];
		this.sortColumn(newSort);
	}

	updateFilterPopup = () => {
		const addFilter = (property, operator, value, index) => {
			const template = this.shadowRoot.querySelector('#filter-template');
			const clone = template.content.cloneNode(true);
			const container = clone.querySelector('.filter');
			const column = this.columns.find(a => a.property === property);
			const filterMulti = clone.querySelector('.filter-and-or');
			const filterProperty = clone.querySelector('.filter-column');
			const filterOperator = clone.querySelector(`.filter-operator.${column.type}`);
			const filterInput = clone.querySelector(`.filter-input.${column.type}`);
			const filterRemove = clone.querySelector('.filter-remove-btn');
			const onFilterUpdate = (e) => {
				const container = e.target.closest('.filter');
				const prop = container.querySelector('.filter-column');
				const col = this.columns.find(a => a.property === prop.value);
				const filter = { column: prop.value, operator: container.querySelector(`.filter-operator.${col.type}`).value, value: container.querySelector(`.filter-input.${col.type}`).value };
				const filters = [...this.filters];
				filters[index] = filter;
				this.filters = filters;
			};

			this._columns.forEach(col => {
				const option = document.createElement('option');
				option.textContent = col.name;
				option.value = col.property;
				filterProperty.appendChild(option);
			});
			
			filterProperty.value = property;
			filterMulti.value = this.#multiFilterOperator;
			filterOperator.value = operator;
			filterInput.value = value;
			container.setAttribute('data-type', column.type);

			filterMulti.addEventListener('change', (e) => {
				this.#multiFilterOperator = e.target.value; 
				onFilterUpdate(e);
			});
			filterProperty.addEventListener('change', onFilterUpdate);
			filterOperator.addEventListener('change', onFilterUpdate);
			filterInput.addEventListener('change', onFilterUpdate);
			filterRemove.addEventListener('click', () => {
				this.filters = this.filters.filter((a, i) => i !== index);
			});

			this.#filterPopup.appendChild(clone);
		};
		
		this.#filterPopup.innerHTML = '';
		this.filters.forEach((filter, index) => addFilter(filter.column, filter.operator, filter.value, index));
	}
	
	updateFooter = () => {
		const selectedCount = this.selected.length;
		const totalPages = this.getTotalPages();

		this.#footerCurrentPage.innerText = this.page + 1;
		this.#footerPrevBtn.disabled = this.page <= 0;
		this.#footerNextBtn.disabled = this.page + 1 >= totalPages;

		const hidden = selectedCount === 0;
		this.#footerSelectedNumber.innerText = hidden ? '' : selectedCount;
		this.#footerSelectedNumber.hidden = hidden;
		this.#footerSelectedMulti.hidden = hidden || selectedCount === 1;
		this.#footerSelectedSingle.hidden = hidden || selectedCount !== 1;

		this.#footerPageSize.value = this.pageSize;
	}

	updateHeader = () => {
		this.#header.innerHTML = '';
		this.#header.appendChild(this.buildRow(this._columns, -1, true));
	}

	updateTotalPages = () => {
		const currentTotal = parseInt(this.#footerTotalPages.innerText);
		if (currentTotal != this.getTotalPages()) {
			this.#footerTotalPages.innerText = this.getTotalPages();
		}
	}

	updateVisibilityPopup = () => {
		if (!this.columns) return;

		this.#visibilityPopup.innerHTML = '';
		const disableLastInput = this.columns.filter(a => !a.hidden).length <= 1;

		this.columns.forEach((col, index) => {
			const wrapper = document.createElement('div');
			wrapper.innerHTML = `
				<input id='vis-${col.property}' type='checkbox' ${col.hidden ? '' : 'checked'} ${!col.hidden && disableLastInput ? 'disabled' : ''}>
				<label for='vis-${col.property}'>${col.name}</label>
			`;
			wrapper.querySelector('input').addEventListener('change', (e) => {
				const columns = [ ...this.columns ];
				columns[index].hidden = !e.target.checked;
				this.columns = columns;
				this.forceRender();
			});
			this.#visibilityPopup.appendChild(wrapper);
		});
	}
}

customElements.define('ac-table', Table);
